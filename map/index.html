<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Disaster Dashboard</title>
<link href="https://cdn.tailwindcss.com" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="flex h-screen">

  <!-- Sidebar -->
  <aside class="w-1/4 bg-white p-4 border-r overflow-y-auto">
    <h2 class="font-bold text-xl mb-4">Resources</h2>
    <div id="resource-list" class="space-y-2"></div>

    <h2 class="font-bold text-xl mt-8 mb-2">Statistics</h2>
    <div id="stats" class="space-y-1 text-sm text-gray-700">
      <p>Shelters: <span id="count-shelter">0</span></p>
      <p>Medical Camps: <span id="count-medical">0</span></p>
      <p>Food Distributions: <span id="count-food">0</span></p>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">
    <!-- Map -->
    <div id="map" class="flex-1"></div>

    <!-- Chat -->
    <div class="h-64 bg-white border-t p-4 flex flex-col">
      <h3 class="font-bold mb-2">Live Emergency Chat</h3>
      <div id="chat-box" class="flex-1 overflow-y-auto mb-2 border p-2 rounded"></div>
      <div class="flex gap-2">
        <input id="chat-input" class="flex-1 border px-2 py-1 rounded" placeholder="Type message..." />
        <button id="chat-send" class="bg-blue-500 text-white px-3 py-1 rounded">Send</button>
      </div>
    </div>
  </div>

</div>

<script>
  // ---------------- Map Setup ----------------
  mapboxgl.accessToken = 'pk.1831c6b95b1c0a41b3ecf9e4899bedec';
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [77.2090, 28.6139],
    zoom: 10
  });

  // Fetch resource data from backend
  async function loadResources() {
    const res = await fetch('http://localhost:5000/api/resources');
    const data = await res.json();

    // Reset sidebar and stats
    document.getElementById('resource-list').innerHTML = '';
    let shelterCount = 0, medicalCount = 0, foodCount = 0;

    data.forEach(resource => {
      // Add marker
      new mapboxgl.Marker({ color: resource.color })
        .setLngLat([resource.lng, resource.lat])
        .setPopup(new mapboxgl.Popup().setHTML(`
          <h4>${resource.name}</h4>
          <p>Type: ${resource.type}</p>
          <p>Status: ${resource.status}</p>
          <p>Contact: ${resource.contact}</p>
        `))
        .addTo(map);

      // Add to sidebar
      const div = document.createElement('div');
      div.className = 'p-2 border-b';
      div.innerHTML = `<strong>${resource.name}</strong><br>${resource.type} - ${resource.status}`;
      document.getElementById('resource-list').appendChild(div);

      // Stats
      if(resource.type === "Shelter") shelterCount++;
      if(resource.type === "Medical") medicalCount++;
      if(resource.type === "Food") foodCount++;
    });

    document.getElementById('count-shelter').innerText = shelterCount;
    document.getElementById('count-medical').innerText = medicalCount;
    document.getElementById('count-food').innerText = foodCount;
  }

  map.on('load', loadResources);

  // ---------------- Chat Setup ----------------
  const socket = io('http://localhost:5000');
  const chatBox = document.getElementById('chat-box');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');

  socket.on('receiveMessage', msg => {
    const div = document.createElement('div');
    div.textContent = msg;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  chatSend.addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if(msg) {
      socket.emit('sendMessage', msg);
      chatInput.value = '';
    }
  });

</script>
</body>
</html>
